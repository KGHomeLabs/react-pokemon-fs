name: PR Comment Summary

on:
     pull_request:
          types: [opened, synchronize, reopened]

jobs:
     comment:
          runs-on: ubuntu-latest

          steps:
               - name: Checkout code
                 uses: actions/checkout@v4

               - name: Get PR Commit Messages
                 id: get_commits
                 run: |
                      COMMITS=$(gh pr view ${{ github.event.pull_request.number }} --json commits -q '.commits[].message')
                      echo "commit_messages<<EOF" >> $GITHUB_OUTPUT
                      echo "$COMMITS" >> $GITHUB_OUTPUT
                      echo "EOF" >> $GITHUB_OUTPUT
                 env:
                      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

               - name: Create Comment Body
                 id: create_comment
                 run: |
                      body="These are the aggregated commits since last PR (auto-generated)\n"
                      echo "${{ steps.get_commits.outputs.commit_messages }}" | grep -Eo '#[0-9]+' | sort | uniq | while read issue; do
                        issue_number=$(echo "$issue" | tr -d '#')
                        body+="âœ… [${issue}](https://github.com/${{ github.repository }}/issues/${issue_number})\n"
                      done
                      echo "body<<EOF" >> $GITHUB_OUTPUT
                      echo -e "$body" >> $GITHUB_OUTPUT
                      echo "EOF" >> $GITHUB_OUTPUT

               - name: Post comment to PR
                 uses: peter-evans/create-or-update-comment@v4
                 with:
                      issue-number: ${{ github.event.pull_request.number }}
                      body: ${{ steps.create_comment.outputs.body }}
                      token: ${{ secrets.GITHUB_TOKEN }}
